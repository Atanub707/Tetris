name: Build

on:
  push:
    branches:
      - main


jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Shallow clones should be disabled for a better relevancy of analysis
      # - uses: sonarsource/sonarqube-scan-action@master
      #   env:
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #     SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
      # # If you wish to fail your job when the Quality Gate is red, uncomment the
      # # following lines. This would typically be used to fail a deployment.
      # # - uses: sonarsource/sonarqube-quality-gate-action@master
      # #   timeout-minutes: 5
      # #   env:
      # #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      # - name: install trivy
      #   run: |
      #     #install trivy
      #     sudo apt-get install wget apt-transport-https gnupg lsb-release -y
      #     wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
      #     echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
      #     sudo apt-get update
      #     sudo apt-get install trivy -y
      #     #command to scan files
      #     trivy fs .
      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Determine version number
        id: version
        run: |
          VERSION=$(git describe --tags --abbrev=0) # Get the latest version tag
          VERSION=${VERSION:-0.0.0} # Default to 0.0.0 if no tags found
          IFS='.' read -r major minor patch <<< "$VERSION"
          echo "Version $VERSION"

          # Increment patch version
          patch=$((patch+1))
          NEW_VERSION="$major.$minor.$patch"
          echo "::set-output name=new_version::$NEW_VERSION"

      - name: Build and tag Docker image
        run: |
          # Retrieve the new version from the previous step
          VERSION=$GITHUB_REF_SLUG
          echo "Building version $VERSION"

          # Build the Docker image
          docker build -t atanubiswas/tetris:$VERSION .

          # Tag the Docker image with the latest version
          docker tag your/image-name:$VERSION atanubiswas/tetris:latest

          # Push the Docker images to the registry
          docker push atanubiswas/tetris:$VERSION
          docker push atanubiswas/tetris:latest